<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>Guided Proof</title>

<link rel="stylesheet" href="css/guided.css">

<style>
/* --- 1. Fixed & Slim Progress Bar --- */
#progress-container {
    position: fixed; /* Stick to top */
    top: 0;
    left: 0;
    width: 100%;
    height: 5px; /* Very slim to save space */
    background-color: #e2e8f0;
    border-radius: 0; /* Flat edges */
    z-index: 2000; /* Ensure it stays on top of everything */
    margin: 0;
}

#progress-fill {
    height: 100%;
    width: 0%;
    background-color: #3182ce;
    transition: width 0.3s ease-in-out;
}

/* --- 2. Tighter Footer & Layout --- */
body {
    /* Reduce bottom padding. 
       We only need enough so the footer isn't hidden behind the 
       ~70px height of the sticky buttons. */
    padding-bottom: 70px; 
    
    /* Add a tiny bit of top padding so the first title 
       doesn't get covered by the progress bar */
    padding-top: 15px; 
}

footer {
    /* Reduce the gap between the proof content and the home button */
    margin-top: 1.5rem; 
    padding-top: 1rem;
    padding-bottom: 1rem;
    
    /* Remove border if you want it to look cleaner/closer */
    border-top: none; 
    display: flex;
    justify-content: center;
}

.home-link {
    /* Make the button slightly more compact */
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    max-width: 200px;
}
</style>

<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
  // Simple config, we will handle scaling via CSS
  startup: { typeset: false }
};
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>

<main>
  <h2 id="proof-title">Loading Proof...</h2>
  
  <div id="progress-container">
      <div id="progress-fill"></div>
  </div>
  
  <div id="steps-container"></div>
    
  <div id="buttons">
      <button id="hint-btn" disabled>Show Hint</button>
      <button id="reveal-btn" disabled>Reveal Step</button>
  </div>
</main>

<footer>
    <a href="index.html" class="home-link">üè† Home</a>
</footer>

<script>
// --- Configuration & Setup ---
const urlParams = new URLSearchParams(window.location.search);
const proofId = urlParams.get('id');

// Global State
let currentStep = 0;
let proofData = null;

// DOM Elements
const stepsContainer = document.getElementById("steps-container");
const hintBtn = document.getElementById("hint-btn");
const revealBtn = document.getElementById("reveal-btn");
const buttonsDiv = document.getElementById("buttons");
const titleElem = document.getElementById("proof-title");
const progressFill = document.getElementById("progress-fill"); // NEW reference

// --- Helper: Robustly Render MathJax ---
function renderMath() {
  if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
      MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
  } else {
      console.log("MathJax not ready, retrying...");
      setTimeout(renderMath, 50);
  }
}

// --- Helper: Update Progress Bar ---
function updateProgress() {
    if (!proofData) return;
    const total = proofData.steps.length;
    // Calculate percentage
    const percent = (currentStep / total) * 100;
    progressFill.style.width = percent + "%";
}

// --- 1. Load Data ---
if (proofId) {
    fetch(`proofs/${proofId}.json`)
        .then(response => {
            if (!response.ok) throw new Error(`Proof file not found (${response.status})`);
            return response.json();
        })
        .then(data => {
            proofData = data;
            initProof();
        })
        .catch(err => {
            console.error("Load Error:", err);
            titleElem.innerText = "Error";
            stepsContainer.innerHTML = `
                <div class='error'>
                    <h3>‚ö†Ô∏è Could not load proof</h3>
                    <p>Details: ${err.message}</p>
                    <p><strong>Note:</strong> If you are opening this file directly from your folder (file://), this will not work due to browser security (CORS). You must use a local server.</p>
                </div>`;
            buttonsDiv.style.display = 'none';
        });
} else {
    titleElem.innerText = "Welcome";
    stepsContainer.innerHTML = "<p>Please select a proof from the <a href='index.html'>Home Page</a>.</p>";
    buttonsDiv.style.display = 'none';
}

// --- 2. Initialize Logic ---
function initProof() {
    titleElem.innerText = proofData.title; 
    revealBtn.disabled = false; 
    updateProgress(); // Initialize bar at 0%
    showPrompt();
}

// --- 3. Core Functions ---
function showPrompt() {
  // Check if we have reached the end of the steps
  if (currentStep >= proofData.steps.length) {
    hintBtn.style.display = 'none';
    revealBtn.innerText = "Reveal Full Proof";
    return;
  }

  const step = proofData.steps[currentStep];
  
  // Create Prompt Element
  const promptDiv = document.createElement("div");
  promptDiv.className = "prompt";
  promptDiv.innerHTML = `<p><strong>Step ${currentStep + 1}:</strong> ${step.prompt}</p>`;
  stepsContainer.appendChild(promptDiv);
  
  // UX: Scroll and Render Math
  promptDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
  renderMath();

  // Handle Hint Button State
  if (!step.hint) {
      hintBtn.disabled = true;
  } else {
      hintBtn.disabled = false;
  }
}

hintBtn.onclick = () => {
  const step = proofData.steps[currentStep];
  if (currentStep < proofData.steps.length && step.hint) {
    const hintDiv = document.createElement("div");
    hintDiv.className = "hint";
    hintDiv.innerHTML = "<strong>Hint: </strong>" + step.hint;
    stepsContainer.appendChild(hintDiv);
    
    renderMath();
    
    hintBtn.disabled = true;
    
    hintDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
};

revealBtn.onclick = () => {
  // Case A: Revealing the next step
  if (currentStep < proofData.steps.length) {
    const step = proofData.steps[currentStep];
    const revealDiv = document.createElement("div");
    revealDiv.className = "reveal";
    revealDiv.innerHTML = step.reveal;
    stepsContainer.appendChild(revealDiv);
    
    renderMath();

    currentStep++;
    updateProgress(); // Update the bar
    showPrompt(); 
  }
  // Case B: Showing the full proof summary
  else {
      const finalMsg = document.createElement("div");
      finalMsg.className = "finished";
      
      finalMsg.innerHTML = `<h3>${proofData.title}</h3>${proofData.fullProofHtml}`;
      stepsContainer.appendChild(finalMsg);
      
      // Force bar to 100% when finished
      progressFill.style.width = "100%"; 

      renderMath();
      finalMsg.scrollIntoView({ behavior: 'smooth' });

      // Change interaction buttons to a Restart button
      buttonsDiv.innerHTML = `<button class="restart-btn" onclick="window.location.reload()">üîÑ Restart Proof</button>`;
  }
};
</script>
</body>
</html>