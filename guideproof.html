<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Guided Proof</title>
<link rel="stylesheet" href="css/guided.css">

<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
  startup: {
    typeset: false // We will handle typesetting manually
  }
};
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>

<main>
  <h2 id="proof-title">Loading Proof...</h2>
  
  <div id="steps-container"></div>
  
  <div id="buttons">
      <button id="hint-btn" disabled>Show Hint</button>
      <button id="reveal-btn" disabled>Reveal Step</button>
  </div>
</main>

<footer>
    <a href="index.html" class="home-link">üè† Home</a>
</footer>

<script>
// --- Configuration & Setup ---
const urlParams = new URLSearchParams(window.location.search);
const proofId = urlParams.get('id');

// Global State
let currentStep = 0;
let proofData = null;

// DOM Elements
const stepsContainer = document.getElementById("steps-container");
const hintBtn = document.getElementById("hint-btn");
const revealBtn = document.getElementById("reveal-btn");
const buttonsDiv = document.getElementById("buttons");
const titleElem = document.getElementById("proof-title");

// --- Helper: Robustly Render MathJax ---
function renderMath() {
  if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
      MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
  } else {
      console.log("MathJax not ready, retrying...");
      setTimeout(renderMath, 50);
  }
}

// --- 1. Load Data ---
if (proofId) {
    fetch(`proofs/${proofId}.json`)
        .then(response => {
            if (!response.ok) throw new Error(`Proof file not found (${response.status})`);
            return response.json();
        })
        .then(data => {
            proofData = data;
            initProof();
        })
        .catch(err => {
            console.error("Load Error:", err);
            titleElem.innerText = "Error";
            stepsContainer.innerHTML = `
                <div class='error'>
                    <h3>‚ö†Ô∏è Could not load proof</h3>
                    <p>Details: ${err.message}</p>
                    <p><strong>Note:</strong> If you are opening this file directly from your folder (file://), this will not work due to browser security (CORS). You must use a local server.</p>
                </div>`;
            buttonsDiv.style.display = 'none';
        });
} else {
    titleElem.innerText = "Welcome";
    stepsContainer.innerHTML = "<p>Please select a proof from the <a href='index.html'>Home Page</a>.</p>";
    buttonsDiv.style.display = 'none';
}

// --- 2. Initialize Logic ---
function initProof() {
    titleElem.innerText = proofData.title; // Set Header Title
    revealBtn.disabled = false; // Enable 'Reveal' button
    showPrompt();
}

// --- 3. Core Functions ---
function showPrompt() {
  // Check if we have reached the end of the steps
  if (currentStep >= proofData.steps.length) {
    hintBtn.style.display = 'none';
    revealBtn.innerText = "Reveal Full Proof";
    return;
  }

  const step = proofData.steps[currentStep];
  
  // Create Prompt Element
  const promptDiv = document.createElement("div");
  promptDiv.className = "prompt";
  promptDiv.innerHTML = `<p><strong>Step ${currentStep + 1}:</strong> ${step.prompt}</p>`;
  stepsContainer.appendChild(promptDiv);
  
  // UX: Scroll and Render Math
  promptDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
  renderMath();

  // Handle Hint Button State
  if (!step.hint) {
      hintBtn.disabled = true;
  } else {
      hintBtn.disabled = false;
  }
}

hintBtn.onclick = () => {
  const step = proofData.steps[currentStep];
  if (currentStep < proofData.steps.length && step.hint) {
    const hintDiv = document.createElement("div");
    hintDiv.className = "hint";
    hintDiv.innerHTML = "<strong>Hint: </strong>" + step.hint;
    stepsContainer.appendChild(hintDiv);
    
    renderMath();
    
    hintBtn.disabled = true;
    
    // UPDATED: Now scrolls to CENTER just like the Reveal button
    hintDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
};

revealBtn.onclick = () => {
  // Case A: Revealing the next step
  if (currentStep < proofData.steps.length) {
    const step = proofData.steps[currentStep];
    const revealDiv = document.createElement("div");
    revealDiv.className = "reveal";
    revealDiv.innerHTML = step.reveal;
    stepsContainer.appendChild(revealDiv);
    
    renderMath();

    currentStep++;
    showPrompt(); 
  }
  // Case B: Showing the full proof summary
  else {
      const finalMsg = document.createElement("div");
      finalMsg.className = "finished";
      
      finalMsg.innerHTML = `<h3>${proofData.title}</h3>${proofData.fullProofHtml}`;
      stepsContainer.appendChild(finalMsg);
      
      renderMath();
      finalMsg.scrollIntoView({ behavior: 'smooth' });

      // Change interaction buttons to a Restart button
      buttonsDiv.innerHTML = `<button class="restart-btn" onclick="window.location.reload()">üîÑ Restart Proof</button>`;
  }
};
</script>
</body>
</html>